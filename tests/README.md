# Integration Tests

This directory contains integration test scripts that exercise the full routing pipeline on various test boards.

## Running Tests

All test scripts can be run from the project root or from the tests directory:

```bash
# From project root
python3 tests/test_fanout_and_route.py --all

# From tests directory
cd tests
python3 test_fanout_and_route.py --all
```

## Test Scripts

### test_fanout_and_route.py - Full 5-Layer BGA Board Test

The most comprehensive test, exercising BGA/QFN fanout, single-ended routing, differential pair routing, DDR routing with length matching, and power plane creation on a complex 5-layer board.

```bash
# Run all stages (fanout, routing, checks)
python3 tests/test_fanout_and_route.py --all

# Quick mode (reduced scope for faster testing)
python3 tests/test_fanout_and_route.py --all --quick

# Unbuffered output (useful for real-time logging)
python3 tests/test_fanout_and_route.py --all -u

# Run only specific stages
python3 tests/test_fanout_and_route.py --ftdi --lvds    # Only FTDI and LVDS routing
python3 tests/test_fanout_and_route.py --ram --planes   # Only RAM routing and planes

# Run only DRC/connectivity checks (no routing)
python3 tests/test_fanout_and_route.py --onlychecks --ftdi --lvds --ram
```

**Options:**
| Option | Description |
|--------|-------------|
| `--all` | Run all stages: fanout, ftdi, lvds, ram, planes, and checks |
| `--quick` | Run quick test with reduced routing (fewer nets per stage) |
| `--fanout` | Run fanout tests (QFN and BGA fanout) |
| `--ftdi` | Run FTDI single-ended routing tests |
| `--lvds` | Run LVDS differential pair routing tests |
| `--ram` | Run DDR RAM routing tests |
| `--planes` | Run power/ground plane routing tests |
| `--checks` | Run DRC and connectivity checks after routing (skipped in --quick mode) |
| `--onlychecks` | Run only checks, skip all routing stages (requires stage flags like --ftdi to specify which checks) |
| `-u, --unbuffered` | Run python commands with unbuffered output |

**Pipeline stages:**
1. QFN fanout for U2 (ADC interface)
2. BGA fanout for FTDI (U3), ADC (IC1), FPGA (U3), and DDR (U1)
3. Single-ended routing (FTDI data lanes with swappable targets)
4. Differential pair routing (LVDS with length matching)
5. DDR routing (DQS/CK diff pairs + DQ data lanes with auto byte-lane grouping)
6. DRC and connectivity verification after each stage

### test_kit_route.py - 4-Layer Pad-to-Pad Routing Test

Routes directly between pads without fanout on the kit-dev-coldfire-xilinx board. Demonstrates routing without BGA fanout, power plane creation, and disconnected plane repair.

```bash
python3 tests/test_kit_route.py

# Quick mode (only Net* patterns)
python3 tests/test_kit_route.py --quick

# Skip routing, only redo planes
python3 tests/test_kit_route.py --planes-only

# Unbuffered output
python3 tests/test_kit_route.py -u
```

**Pipeline stages:**
1. Route all signals with power net width overrides
2. Create +3.3V and GND planes on all 4 layers
3. Connect disconnected plane regions
4. DRC and connectivity verification

### test_flat_hierarchy.py - 2-Layer Board with GND Plane

Simple 2-layer board test demonstrating GND plane creation and power net width assignments.

```bash
python3 tests/test_flat_hierarchy.py

# With unbuffered output
python3 tests/test_flat_hierarchy.py -u
```

**Pipeline stages:**
1. Create GND plane on B.Cu using `route_planes.py`
2. Route all signals with power net width overrides (GND/VCC at 1.0mm, VPP at 0.7mm)
3. DRC and connectivity verification

The test uses power net configurations generated by `/analyze-power-nets`.

### test_interf_u.py - 2-Layer Non-Rectangular Board

Tests routing on a 2-layer board with a non-rectangular board outline (has a bottom protrusion).

```bash
python3 tests/test_interf_u.py

# With unbuffered output
python3 tests/test_interf_u.py -u
```

**Pipeline stages:**
1. Create VCC and GND planes on both F.Cu and B.Cu
2. Fan out U9 (PGA120 package) nets
3. Route all signals with polygon-based board edge blocking
4. Connect disconnected plane regions
5. DRC and connectivity verification

### test_sonde_u.py - Wide Track Routing Test

Tests routing with wider than default track widths to verify track-to-track clearance handling.

```bash
python3 tests/test_sonde_u.py

# Skip checks
python3 tests/test_sonde_u.py --no-checks

# With unbuffered output
python3 tests/test_sonde_u.py -u
```

**Pipeline stages:**
1. Route with 1.2mm track width, 0.3mm clearance
2. DRC and connectivity verification

## Performance Benchmarks

Results from `test_fanout_and_route.py` (full mode):

| Stage | Nets | Time | Iterations |
|-------|------|------|------------|
| FTDI single-ended | 47/47 | 8.6s | 319K |
| LVDS diff pairs (batch 1) | 28/28 | 29.7s | 10.2M |
| LVDS diff pairs (batch 2) | 28/28 | 28.0s | 12.0M |
| DDR diff pairs | 5/5 | 0.3s | 25K |
| DDR single-ended | 51/51 | 6.2s | 565K |

Rust acceleration provides ~10x speedup vs pure Python.
